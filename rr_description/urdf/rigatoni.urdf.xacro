<?xml version="1.0"?>
<robot name="tricycle_drive" xmlns:xacro="http://ros.org/wiki/xacro">
    <xacro:include filename="$(find velodyne_description)/urdf/VLP-16.urdf.xacro"/>

  <material name="Black">
    <color rgba="0 0 0 1" />
  </material>
  <material name="Grey">
    <color rgba="0.8 0.8 0.8 1" />
  </material>
  <material name="Orange">
    <color rgba="1 0.6 0 1" />
  </material>
  <material name="White">
    <color rgba="1 1 1 1" />
  </material>

  <link name="base_link" />
   <xacro:macro name="null_inertia">
        <inertial>
            <mass value="0.0001"/>
            <inertia ixx="0.0001" ixy="0" ixz="0" iyy="0.0001" iyz="0" izz="0.0001"/>
        </inertial>
    </xacro:macro>

    <xacro:macro name="set_link_color" params="link color">
        <gazebo reference="${link}">
            <material>Gazebo/${color}</material>
        </gazebo>
    </xacro:macro>
    <!-- Robot Footprint -->
  <link name="base_footprint"/>

  <joint name="base_joint" type="fixed">
    <parent link="base_link"/>
    <child link="base_footprint"/>
    <origin xyz="0.0 0.0 0.0" rpy="0 0 0"/>
  </joint>

  <!-- Chassis -->
  <link name="chassis">
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <box size="2 1 0.5" />
      </geometry>
    </collision>

    <visual>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <box size="2 1 0.5" />
      </geometry>
      <material name="Orange" />
    </visual>

    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <mass value="1" />
      <inertia ixx="0.126164" ixy="0.0" ixz="0.0" iyy="0.416519" iyz="0.0" izz="0.481014" />
    </inertial>
  </link>

  <joint name="chassis_joint" type="fixed">
    <origin xyz="0.8 0 0.5" rpy="0 0 0" />
    <parent link="base_link" />
    <child link="chassis" />
  </joint>

  <!-- left wheel Link -->
  <link name="left_wheel">
    <collision>
      <geometry>
        <cylinder length="0.08" radius="0.3" />
      </geometry>
    </collision>
    <visual>
      <geometry>
        <cylinder length="0.08" radius="0.3" />
      </geometry>
      <material name="Black" />
    </visual>

    <inertial>
      <mass value="2" />
      <inertia ixx="0.145833" ixy="0.0" ixz="0.0" iyy="0.145833" iyz="0.0" izz="0.125" />
    </inertial>
  </link>

  <joint name="left_wheel_joint" type="continuous">
    <origin xyz="-0.8 0.5 -0.2" rpy="-1.57 0 0" />
    <parent link="chassis" />
    <child link="left_wheel" />
    <axis xyz="0 0 1" />
    <dynamics damping="0.2" />
  </joint>

  <!-- right wheel Link -->
  <link name="right_wheel">
    <collision>
      <geometry>
        <cylinder length="0.08" radius="0.3" />
      </geometry>
    </collision>
    <visual>
      <geometry>
        <cylinder length="0.08" radius="0.3" />
      </geometry>
      <material name="Black" />
    </visual>

    <inertial>
      <mass value="2" />
      <inertia ixx="0.145833" ixy="0.0" ixz="0.0" iyy="0.145833" iyz="0.0" izz="0.125" />
    </inertial>
  </link>

  <joint name="right_wheel_joint" type="continuous">
    <origin xyz="-0.8 -0.5 -0.2" rpy="-1.57 0 0" />
    <parent link="chassis" />
    <child link="right_wheel" />
    <axis xyz="0 0 1" />
    <dynamics damping="0.2" />
  </joint>

  <!-- Steering Link -->
  <link name="steering_link">
    <visual>
      <geometry>
        <box size="0.01 0.01 0.01" />
      </geometry>
      <material name="Black" />
    </visual>
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <mass value="0.005" />
      <inertia ixx="0.1" ixy="0.0" ixz="0.0" iyy="0.1" iyz="0.0" izz="0.1" />
    </inertial>
  </link>

  <joint name="steering_joint" type="continuous">
    <origin xyz="0.9 0 -0.2" rpy="0 0 0" />
    <parent link="chassis" />
    <child link="steering_link" />
    <axis xyz="0 0 1" />
  </joint>

  <!-- traction wheel link -->
  <link name="wheel_front_link">
    <visual>
      <geometry>
        <cylinder length="0.08" radius="0.3" />
      </geometry>
      <material name="Black" />
    </visual>
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <mass value="15" />
      <inertia ixx="1" ixy="0" ixz="0" iyy="1" iyz="0" izz="1" />
    </inertial>
    <collision>
      <geometry>
        <cylinder length="0.08" radius="0.3" />
      </geometry>
    </collision>
  </link>

  <joint name="traction_joint" type="continuous">
    <parent link="steering_link" />
    <child link="wheel_front_link" />
    <origin xyz="0 0 0" rpy="-1.57 1.57 0" />
    <axis xyz="0 0 1" />
  </joint>

  <ros2_control name="GazeboSystem" type="system">
    <hardware>
      <plugin>gazebo_ros2_control/GazeboSystem</plugin>
    </hardware>
    <joint name="steering_joint">
      <command_interface name="position" />
      <state_interface name="position" />
    </joint>
    <joint name="traction_joint">
      <command_interface name="velocity" />
      <state_interface name="velocity" />
      <state_interface name="position" />
    </joint>
  </ros2_control>

<!-- Sensors -->
    <link name="gps_link">
        <xacro:null_inertia/>
        <visual>
            <geometry>
                <box size="0.05 0.05 0.05"/>
            </geometry>
        </visual>
    </link>
    <xacro:set_link_color link="gps_link" color="Gold"/>

    <link name="camera">
        <xacro:null_inertia/>
        <visual>
            <geometry>
                <box size="0.05 0.05 0.05"/>
            </geometry>
        </visual>
        <visual>
            <origin rpy="0 ${pi/2} 0" xyz="0.05 0 0"/>
            <geometry>
                <cylinder radius="0.03" length="0.05"/>
            </geometry>
        </visual>
    </link>
    <xacro:set_link_color link="camera" color="Gold"/>
   <link name="imu_link">
        <xacro:null_inertia/>
        <visual>
            <geometry>
                <box size="0.05 0.05 0.05"/>
            </geometry>
        </visual>
    </link>
    <xacro:set_link_color link="imu_link" color="Gold"/>

 <xacro:macro name="set_base_footprint_to_link" params="link_name xyz rpy">
        <joint name="base_footprint_to_${link_name}" type="fixed">
            <parent link="base_footprint"/>
            <child link="${link_name}"/>
            <origin xyz="${xyz}" rpy="${rpy}"/>
        </joint>
    </xacro:macro>

    <xacro:set_base_footprint_to_link link_name="gps_link" xyz="0.55 0.39 1.22" rpy="0 0 0"/>

    <xacro:set_base_footprint_to_link link_name="camera" xyz="0.61 0.39 1.03" rpy="0 0.4 0"/>

    <xacro:set_base_footprint_to_link link_name="imu_link" xyz="0.60 0.39 0.95" rpy="0 0 0"/>

<xacro:VLP-16 parent="base_footprint" name="velodyne" topic="/velodyne_points" organize_cloud="false" hz="10" samples="440" gpu="true">
        <origin xyz="1.175 0 0.175" rpy="0 0 0" />
    </xacro:VLP-16>
    
    <!-- FLIR Blackfly + wide-angle lens -->
    <gazebo reference="camera">
        <sensor name="camera_sensor" type="camera">
            <camera>
                <horizontal_fov>1.6955</horizontal_fov>
                <image>
                    <width>1280</width>
                    <height>964</height>
                    <format>R8G8B8</format>
                </image>
                <clip>
                    <near>0.05</near>
                    <far>100</far>
                </clip>
                <noise>
                    <type>gaussian</type>
                    <mean>0.0</mean>
                    <stddev>0.007</stddev>
                </noise>
            </camera>
            <always_on>true</always_on>
            <update_rate>15</update_rate>
            <plugin name="camera_controller" filename="libgazebo_ros_camera.so">
                <alwaysOn>true</alwaysOn>
                <cameraName>camera</cameraName>
                <imageTopicName>image_color_rect</imageTopicName>
                <cameraInfoTopicName>camera_info</cameraInfoTopicName>
                <frameName>camera_optical</frameName>
                <distortionK1>0.0</distortionK1>
                <distortionK2>0.0</distortionK2>
                <distortionK3>0.0</distortionK3>
                <distortionT1>0.0</distortionT1>
                <distortionT2>0.0</distortionT2>
            </plugin>
        </sensor>
    </gazebo>

    <!-- IMU -->
    <gazebo reference="imu_top_link">
        <gravity>true</gravity>
        <sensor name="imu_sensor" type="imu">
            <always_on>true</always_on>
            <update_rate>100</update_rate>
            <visualize>true</visualize>
            <topic>__default_topic__</topic>
            <plugin filename="libgazebo_ros_imu_sensor.so" name="imu_plugin">
                <topicName>imu_top</topicName>
                <bodyName>imu_top_link</bodyName>
                <updateRateHZ>20.0</updateRateHZ>
                <gaussianNoise>0.005</gaussianNoise>
                <xyzOffset>0 0 0</xyzOffset>
                <rpyOffset>0 0 0</rpyOffset>
                <frameName>imu_top_link</frameName>
            </plugin>
            <pose>0 0 0 0 0 0</pose>
        </sensor>
    </gazebo>

    <!-- IMU -->
    <gazebo reference="imu_bottom_link">
        <gravity>true</gravity>
        <sensor name="imu_sensor_bottom" type="imu">
            <always_on>true</always_on>
            <update_rate>100</update_rate>
            <visualize>true</visualize>
            <topic>__default_topic__</topic>
            <plugin filename="libgazebo_ros_imu_sensor.so" name="imu_plugin">
                <topicName>imu_bottom</topicName>
                <bodyName>imu_bottom_link</bodyName>
                <updateRateHZ>20.0</updateRateHZ>
                <gaussianNoise>0.005</gaussianNoise>
                <xyzOffset>0 0 0</xyzOffset>
                <rpyOffset>0 0 0</rpyOffset>
                <frameName>imu_bottom_link</frameName>
            </plugin>
            <pose>0 0 0 0 0 0</pose>
        </sensor>
    </gazebo>

  <gazebo>
    <plugin filename="libgazebo_ros2_control.so" name="gazebo_ros2_control">
      <parameters>$(find rr_description)/config/tricycle_control.yaml</parameters>
    </plugin>
  </gazebo>

</robot>